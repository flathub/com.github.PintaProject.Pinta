name: Pinta
sources:
  - nuget_sources.json
  - type: git
    url: https://github.com/PintaProject/Pinta.git
    #tag: "1.8"
    #commit: 3d6c188680a389c1f9f40138c092b05ba4009b2e
    branch: "gtk3-v2"
    # TODO check for release notes in xdg/pinta.appdata.xml.in
  - type: shell
    commands:
      # Use locally downloaded sources instead of build-options.build-args=["--share=network"]:
      # Generate list via: https://github.com/flatpak/flatpak-builder-tools/tree/master/dotnet/flatpak-dotnet-generator.py nuget_sources.json Pinta.sln
      - sed -i "s|^PINTA_BUILD_OPTS.*|& --source $(pwd)/nuget-sources|" Makefile.am
build-options:
  append-path: /usr/lib/sdk/dotnet5/bin
  append-ld-library-path: /usr/lib/sdk/dotnet5/lib
  env:
    PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/share/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:/usr/lib/sdk/dotnet5/lib/pkgconfig
    DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
post-install:
  - |
    icon_in="xdg/scalable/pinta.svg";
    icon_out="pinta.png";
    for s in {16,22,24,32,36,48,64,72,96,128,192,256,512}; do
      [[ ! -f "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${icon_out}" ]] || continue;
      rsvg-convert "${icon_in}" -w "${s}" -h "${s}" -a -f png -o "${icon_out}";
      install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
  - gtk-update-icon-cache --force --ignore-theme-index "${FLATPAK_DEST}/share/icons/hicolor";
  - |
    for f in "${FLATPAK_DEST}/share/metainfo/pinta.appdata.xml"; do
      xmlstarlet ed --inplace -d '/component/provides/binary' "${f}";
      xmlstarlet ed --inplace -d '/component/provides[not(./*) and (not(./text()) or normalize-space(./text())="")]' "${f}";
    done;
modules:
  - shared-modules/intltool/intltool-0.51.json
  - xmlstarlet.yaml
